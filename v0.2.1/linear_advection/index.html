<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Linear Advection · PositiveIntegrators.jl</title><meta name="title" content="Linear Advection · PositiveIntegrators.jl"/><meta property="og:title" content="Linear Advection · PositiveIntegrators.jl"/><meta property="twitter:title" content="Linear Advection · PositiveIntegrators.jl"/><meta name="description" content="Documentation for PositiveIntegrators.jl."/><meta property="og:description" content="Documentation for PositiveIntegrators.jl."/><meta property="twitter:description" content="Documentation for PositiveIntegrators.jl."/><meta property="og:url" content="https://SKopecz.github.io/PositiveIntegrators.jl/stable/linear_advection/"/><meta property="twitter:url" content="https://SKopecz.github.io/PositiveIntegrators.jl/stable/linear_advection/"/><link rel="canonical" href="https://SKopecz.github.io/PositiveIntegrators.jl/stable/linear_advection/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">PositiveIntegrators.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li class="is-active"><a class="tocitem" href>Linear Advection</a><ul class="internal"><li><a class="tocitem" href="#Definition-of-the-production-destruction-system"><span>Definition of the production-destruction system</span></a></li><li><a class="tocitem" href="#Solution-of-the-production-destruction-system"><span>Solution of the production-destruction system</span></a></li><li><a class="tocitem" href="#Package-versions"><span>Package versions</span></a></li></ul></li><li><a class="tocitem" href="../heat_equation_neumann/">Heat Equation, Neumann BCs</a></li><li><a class="tocitem" href="../heat_equation_dirichlet/">Heat Equation, Dirichlet BCs</a></li></ul></li><li><a class="tocitem" href="../faq/">Troubleshooting, FAQ</a></li><li><a class="tocitem" href="../api_reference/">API reference</a></li><li><a class="tocitem" href="../contributing/">Contributing</a></li><li><a class="tocitem" href="../code_of_conduct/">Code of conduct</a></li><li><a class="tocitem" href="../license/">License</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Linear Advection</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Linear Advection</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SKopecz/PositiveIntegrators.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SKopecz/PositiveIntegrators.jl/blob/main/docs/src/linear_advection.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="tutorial-linear-advection"><a class="docs-heading-anchor" href="#tutorial-linear-advection">Tutorial: Solution of the linear advection equation</a><a id="tutorial-linear-advection-1"></a><a class="docs-heading-anchor-permalink" href="#tutorial-linear-advection" title="Permalink"></a></h1><p>This tutorial is about the efficient solution of production-destruction systems (PDS) with a large number of differential equations. We will explore several ways to represent such large systems and assess their efficiency.</p><h2 id="Definition-of-the-production-destruction-system"><a class="docs-heading-anchor" href="#Definition-of-the-production-destruction-system">Definition of the production-destruction system</a><a id="Definition-of-the-production-destruction-system-1"></a><a class="docs-heading-anchor-permalink" href="#Definition-of-the-production-destruction-system" title="Permalink"></a></h2><p>One example of the occurrence of a PDS with a large number of equations is the space discretization of a partial differential equation. In this tutorial we want to solve the linear advection equation</p><p class="math-container">\[\partial_t u(t,x)=-a\partial_x u(t,x),\quad u(0,x)=u_0(x)\]</p><p>with <span>$a&gt;0$</span>, <span>$t≥ 0$</span>, <span>$x\in[0,1]$</span> and periodic boundary conditions. To keep things as simple as possible, we discretize the space domain as <span>$0=x_0&lt;x_1\dots &lt;x_{N-1}&lt;x_N=1$</span> with <span>$x_i = i Δ x$</span> for <span>$i=0,\dots,N$</span> and <span>$Δx=1/N$</span>. An upwind discretization of the spatial derivative yields the ODE system</p><p class="math-container">\[\begin{aligned}
&amp;\partial_t u_1(t) =-\frac{a}{Δx}\bigl(u_1(t)-u_{N}(t)\bigr),\\
&amp;\partial_t u_i(t) =-\frac{a}{Δx}\bigl(u_i(t)-u_{i-1}(t)\bigr),\quad i=2,\dots,N,
\end{aligned}\]</p><p>where <span>$u_i(t)$</span> is an approximation of <span>$u(t,x_i)$</span> for <span>$i=1,\dots, N$</span>. This system can also be written as <span>$\partial_t \mathbf u(t)=\mathbf A\mathbf u(t)$</span> with <span>$\mathbf u(t)=(u_1(t),\dots,u_N(t))$</span> and</p><p class="math-container">\[\mathbf A= \frac{a}{Δ x}\begin{bmatrix}-1&amp;0&amp;\dots&amp;0&amp;1\\1&amp;-1&amp;\ddots&amp;&amp;0\\0&amp;\ddots&amp;\ddots&amp;\ddots&amp;\vdots\\ \vdots&amp;\ddots&amp;\ddots&amp;\ddots&amp;0\\0&amp;\dots&amp;0&amp;1&amp;-1\end{bmatrix}.\]</p><p>In particular the matrix <span>$\mathbf A$</span> shows that there is a single production term and a single destruction term per equation. Furthermore, the system is conservative as <span>$\mathbf A$</span> has column sum zero. To be precise, the production matrix <span>$\mathbf P = (p_{i,j})$</span> of this conservative PDS is given by</p><p class="math-container">\[\begin{aligned}
&amp;p_{1,N}(t,\mathbf u(t)) = \frac{a}{Δ x}u_N(t),\\
&amp;p_{i,i-1}(t,\mathbf u(t)) = \frac{a}{Δ x}u_{i-1}(t),\quad i=2,\dots,N.
\end{aligned}\]</p><p>Since the PDS is conservative, we have <span>$d_{i,j}=p_{j,i}$</span> and the system is fully determined by the production matrix <span>$\mathbf P$</span>.</p><h2 id="Solution-of-the-production-destruction-system"><a class="docs-heading-anchor" href="#Solution-of-the-production-destruction-system">Solution of the production-destruction system</a><a id="Solution-of-the-production-destruction-system-1"></a><a class="docs-heading-anchor-permalink" href="#Solution-of-the-production-destruction-system" title="Permalink"></a></h2><p>Now we are ready to define a <code>ConservativePDSProblem</code> and to solve this problem with a method of <a href="https://github.com/SKopecz/PositiveIntegrators.jl">PositiveIntegrators.jl</a> or <a href="https://docs.sciml.ai/OrdinaryDiffEq/stable/">OrdinaryDiffEq.jl</a>. In the following we use <span>$a=1$</span>, <span>$N=1000$</span> and the time domain <span>$t\in[0,1]$</span>. Moreover, we choose the step function</p><p class="math-container">\[u_0(x)=\begin{cases}1, &amp; 0.4 ≤ x ≤ 0.6,\\ 0,&amp; \text{elsewhere}\end{cases}\]</p><p>as initial condition. Due to the periodic boundary conditions and the transport velocity <span>$a=1$</span>, the solution at time <span>$t=1$</span> is identical to the initial distribution, i.e. <span>$u(1,x) = u_0(x)$</span>.</p><pre><code class="language-julia hljs">N = 1000 # number of subintervals
dx = 1/N # mesh width
x = LinRange(dx, 1.0, N) # discretization points x_1,...,x_N = x_0
u0 = @. 0.0 + (0.4 ≤ x ≤ 0.6) * 1.0 # initial solution
tspan = (0.0, 1.0) # time domain</code></pre><p>As mentioned above, we will try different approaches to solve this PDS and compare their efficiency. These are</p><ol><li>an in-place implementation with a dense matrix,</li><li>an in-place implementation with a sparse matrix.</li></ol><h3 id="Standard-in-place-implementation"><a class="docs-heading-anchor" href="#Standard-in-place-implementation">Standard in-place implementation</a><a id="Standard-in-place-implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Standard-in-place-implementation" title="Permalink"></a></h3><p>By default, we will use dense matrices to store the production terms and to setup/solve the linear systems arising in MPRK methods. Of course, this is not efficient for large and sparse systems like in this case.</p><pre><code class="language-julia hljs">using PositiveIntegrators # load ConservativePDSProblem

function lin_adv_P!(P, u, p, t)
    fill!(P, 0.0)
    N = length(u)
    dx = 1 / N
    P[1, N] = u[N] / dx
    for i in 2:N
        P[i, i - 1] = u[i - 1] / dx
    end
    return nothing
end

prob = ConservativePDSProblem(lin_adv_P!, u0, tspan) # create the PDS

sol = solve(prob, MPRK43I(1.0, 0.5); save_everystep = false)</code></pre><pre><code class="language-julia hljs">using Plots

plot(x, u0; label = &quot;u0&quot;, xguide = &quot;x&quot;, yguide = &quot;u&quot;)
plot!(x, last(sol.u); label = &quot;u&quot;)</code></pre><img src="92caa32a.svg" alt="Example block output"/><h3 id="Using-sparse-matrices"><a class="docs-heading-anchor" href="#Using-sparse-matrices">Using sparse matrices</a><a id="Using-sparse-matrices-1"></a><a class="docs-heading-anchor-permalink" href="#Using-sparse-matrices" title="Permalink"></a></h3><p>To use different matrix types for the production terms and linear systems, you can use the keyword argument <code>p_prototype</code> of <a href="../api_reference/#PositiveIntegrators.ConservativePDSProblem"><code>ConservativePDSProblem</code></a> and <a href="../api_reference/#PositiveIntegrators.PDSProblem"><code>PDSProblem</code></a>.</p><pre><code class="language-julia hljs">using SparseArrays
p_prototype = spdiagm(-1 =&gt; ones(eltype(u0), N - 1),
                      N - 1 =&gt; ones(eltype(u0), 1))
prob_sparse = ConservativePDSProblem(lin_adv_P!, u0, tspan; p_prototype=p_prototype)

sol_sparse = solve(prob_sparse, MPRK43I(1.0, 0.5); save_everystep = false)</code></pre><pre><code class="language-julia hljs">plot(x,u0; label = &quot;u0&quot;, xguide = &quot;x&quot;, yguide = &quot;u&quot;)
plot!(x, last(sol_sparse.u); label = &quot;u&quot;)</code></pre><img src="8d5adc6a.svg" alt="Example block output"/><h3 id="Performance-comparison"><a class="docs-heading-anchor" href="#Performance-comparison">Performance comparison</a><a id="Performance-comparison-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-comparison" title="Permalink"></a></h3><p>Finally, we use <a href="https://github.com/JuliaCI/BenchmarkTools.jl">BenchmarkTools.jl</a> to compare the performance of the different implementations.</p><pre><code class="language-julia hljs">using BenchmarkTools
@benchmark solve(prob, MPRK43I(1.0, 0.5); save_everystep = false)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 1 sample with 1 evaluation.
 Single result which took <span class="sgr34">39.132 s</span> (0.43% GC) to evaluate,
 with a memory estimate of <span class="sgr33">20.19 GiB</span>, over <span class="sgr33">8154</span> allocations.</code></pre><pre><code class="language-julia hljs">@benchmark solve(prob_sparse, MPRK43I(1.0, 0.5); save_everystep = false)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 4 samples with 1 evaluation.
 Range <span class="sgr90">(</span><span class="sgr36"><span class="sgr1">min</span></span> … <span class="sgr35">max</span><span class="sgr90">):  </span><span class="sgr36"><span class="sgr1">1.268 s</span></span> … <span class="sgr35">  1.299 s</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>min … max<span class="sgr90">): </span>1.13% … 1.43%
 Time  <span class="sgr90">(</span><span class="sgr34"><span class="sgr1">median</span></span><span class="sgr90">):     </span><span class="sgr34"><span class="sgr1">1.282 s              </span></span><span class="sgr90">┊</span> GC <span class="sgr90">(</span>median<span class="sgr90">):    </span>1.45%
 Time  <span class="sgr90">(</span><span class="sgr32"><span class="sgr1">mean</span></span> ± <span class="sgr32">σ</span><span class="sgr90">):   </span><span class="sgr32"><span class="sgr1">1.283 s</span></span> ± <span class="sgr32">13.065 ms</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>mean ± σ<span class="sgr90">):  </span>1.42% ± 0.22%

  █              <span class="sgr34">█</span>           <span class="sgr32"> </span>       █                    █  
  █▁▁▁▁▁▁▁▁▁▁▁▁▁▁<span class="sgr34">█</span>▁▁▁▁▁▁▁▁▁▁▁<span class="sgr32">▁</span>▁▁▁▁▁▁▁█▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁█ ▁
  1.27 s<span class="sgr90">         Histogram: frequency by time</span>         1.3 s <span class="sgr1">&lt;</span>

 Memory estimate<span class="sgr90">: </span><span class="sgr33">1.77 GiB</span>, allocs estimate<span class="sgr90">: </span><span class="sgr33">97465</span>.</code></pre><p>By default, we use an LU factorization for the linear systems. At the time of writing, Julia uses <a href="https://github.com/JuliaSparse/SparseArrays.jl">SparseArrays.jl</a> defaulting to UMFPACK from SuiteSparse in this case. However, the linear systems do not necessarily have the structure for which UMFPACK is optimized for. Thus, it is often possible to gain performance by switching to KLU instead.</p><pre><code class="language-julia hljs">using LinearSolve
@benchmark solve(prob_sparse, MPRK43I(1.0, 0.5; linsolve = KLUFactorization()); save_everystep = false)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 22 samples with 1 evaluation.
 Range <span class="sgr90">(</span><span class="sgr36"><span class="sgr1">min</span></span> … <span class="sgr35">max</span><span class="sgr90">):  </span><span class="sgr36"><span class="sgr1">196.046 ms</span></span> … <span class="sgr35">635.535 ms</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>min … max<span class="sgr90">): </span>0.00% … 66.14%
 Time  <span class="sgr90">(</span><span class="sgr34"><span class="sgr1">median</span></span><span class="sgr90">):     </span><span class="sgr34"><span class="sgr1">208.109 ms               </span></span><span class="sgr90">┊</span> GC <span class="sgr90">(</span>median<span class="sgr90">):    </span>0.00%
 Time  <span class="sgr90">(</span><span class="sgr32"><span class="sgr1">mean</span></span> ± <span class="sgr32">σ</span><span class="sgr90">):   </span><span class="sgr32"><span class="sgr1">229.651 ms</span></span> ± <span class="sgr32"> 91.264 ms</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>mean ± σ<span class="sgr90">):  </span>9.18% ± 14.13%

  ██<span class="sgr34">▃</span>▁ <span class="sgr32"> </span>                                                         
  ██<span class="sgr34">█</span>█▁<span class="sgr32">▇</span>▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▄ ▁
  196 ms<span class="sgr90">           Histogram: frequency by time</span>          636 ms <span class="sgr1">&lt;</span>

 Memory estimate<span class="sgr90">: </span><span class="sgr33">63.83 MiB</span>, allocs estimate<span class="sgr90">: </span><span class="sgr33">10960</span>.</code></pre><h2 id="Package-versions"><a class="docs-heading-anchor" href="#Package-versions">Package versions</a><a id="Package-versions-1"></a><a class="docs-heading-anchor-permalink" href="#Package-versions" title="Permalink"></a></h2><p>These results were obtained using the following versions.</p><pre><code class="language-julia hljs">using InteractiveUtils
versioninfo()
println()

using Pkg
Pkg.status([&quot;PositiveIntegrators&quot;, &quot;SparseArrays&quot;, &quot;KLU&quot;, &quot;LinearSolve&quot;, &quot;OrdinaryDiffEq&quot;],
           mode=PKGMODE_MANIFEST)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Julia Version 1.10.4
Commit 48d4fd48430 (2024-06-04 10:41 UTC)
Build Info:
  Official https://julialang.org/ release
Platform Info:
  OS: Linux (x86_64-linux-gnu)
  CPU: 4 × AMD EPYC 7763 64-Core Processor
  WORD_SIZE: 64
  LIBM: libopenlibm
  LLVM: libLLVM-15.0.7 (ORCJIT, znver3)
Threads: 1 default, 0 interactive, 1 GC (on 4 virtual cores)
Environment:
  JULIA_PKG_SERVER_REGISTRY_PREFERENCE = eager

<span class="sgr32"><span class="sgr1">Status</span></span> `~/work/PositiveIntegrators.jl/PositiveIntegrators.jl/docs/Manifest.toml`
  <span class="sgr90">[ef3ab10e] </span>KLU v0.6.0
  <span class="sgr90">[7ed4a6bd] </span>LinearSolve v2.30.2
  <span class="sgr90">[1dea7af3] </span>OrdinaryDiffEq v6.87.0
  <span class="sgr90">[d1b20bf0] </span>PositiveIntegrators v0.2.1 `~/work/PositiveIntegrators.jl/PositiveIntegrators.jl`
  <span class="sgr90">[2f01184e] </span>SparseArrays v1.10.0</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../heat_equation_neumann/">Heat Equation, Neumann BCs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Monday 29 July 2024 07:17">Monday 29 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
